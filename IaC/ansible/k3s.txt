  - path: /tmp/runinstall.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      exec >> /tmp/k3s_install.log 2>&1
      set -e
      
      log() {
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a /tmp/k3s_install.log | tee /dev/console
      }
      
      log "Starting k3s installation on $(hostname)"
      
      export INSTALL_K3S_VERSION="v1.34.1+k3s1"
      export K3S_TOKEN="N2260mN2260m"
      
      K3SVARS="--node-name ${var.cluster_name}-node${count.index} ${local.appgroup_labels} --node-label clustername=${var.cluster_name}"
      
      if echo "$(hostname)" | grep -q "node0"; then
        log "Installing as SERVER (first node)"
        export INSTALL_K3S_EXEC="server --cluster-init --tls-san ${var.cluster_name}-node0.abode.tailandtraillabs.org $K3SVARS"
      else
        sleep 60
        log "Installing as AGENT"
        export K3S_URL="https://${var.cluster_name}-node0.abode.tailandtraillabs.org:6443"
        export INSTALL_K3S_EXEC="agent $K3SVARS"
      fi
      
      log "Downloading k3s installer..."
      curl -sfL https://get.k3s.io -o /tmp/k3s_installer.sh
      
      log "Running k3s installer with: "
      log "INSTALL_K3S_EXEC=$INSTALL_K3S_EXEC"
      log "K3S_URL=$K3S_URL"
      log "INSTALL_K3S_VERSION=$INSTALL_K3S_VERSION"
      sh /tmp/k3s_installer.sh >> /tmp/k3s_install.log 2>&1      
      log "k3s installation complete"
      if echo "$(hostname)" | grep -q "node0"; then
        mkdir /danas
        mount danas.hangar.bpfx.org:/volume1/dataz /danas
        sed 's/127.0.0.1/${var.cluster_name}-node0.abode.tailandtraillabs.org/g' /etc/rancher/k3s/k3s.yaml > /danas/kube/k3s-${var.cluster_name}-node0-config.yaml
        sync
        chmod 644 /danas/kube/k3s-${var.cluster_name}-node0-config.yaml
        sync
        log "Copied k3s config to /danas/kube/"

        sleep 1
        log "Waiting for k3s to be ready..."
        until kubectl get nodes &> /dev/null; do
          sleep 5
        done    

        log "Creating external-dns namespace..."
        kubectl create namespace external-dns || true

        log "Creating AWS credentials secret..."
        source /tmp/aws_credentials
        kubectl create secret generic route53-credentials \
          -n external-dns \
          --from-literal=aws-access-key-id="$AWS_ACCESS_KEY_ID" \
          --from-literal=aws-secret-access-key="$AWS_SECRET_ACCESS_KEY" \
          --dry-run=client -o yaml | kubectl apply -f -

        log "Creating argocd namespace..."
        kubectl create namespace argocd || true
      
        log "Installing ArgoCD..."
        kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
        
        log "Waiting for ArgoCD to be ready..."
        kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd

        log "Creating ArgoCD in-cluster secret..."
        kubectl create secret generic cluster-in-cluster \
          -n argocd \
          --from-literal=name=in-cluster \
          --from-literal=server=https://kubernetes.default.svc \
          --dry-run=client -o yaml | kubectl apply -f -

        kubectl label secret cluster-in-cluster \
          -n argocd \
          argocd.argoproj.io/secret-type=cluster \
          cluster-name="${var.cluster_name}" \
          --overwrite
          
        log "Install the core app"
        kubectl apply -f https://raw.githubusercontent.com/travismontana/ttl-ops/refs/heads/main/appgroups/core/core.argoappset.yaml

        umount /danas
        sync
        sync
      fi