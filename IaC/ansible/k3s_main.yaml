---
- name: Build dynamic inventory from clusters.json
  hosts: localhost
  connection: local
  gather_facts: no
  remote_user: root
  vars:
    clusters_file: "./clusters.json"
  
  tasks:
    - name: Read clusters.json
      slurp:
        src: "{{ clusters_file }}"
      register: clusters_raw

    - name: Parse clusters JSON
      set_fact:
        clusters_data: "{{ clusters_raw.content | b64decode | from_json }}"

    - name: Add hosts dynamically
      add_host:
        name: "{{ item.0.name }}-node{{ item.1 }}"
        ansible_user: ubuntu
        groups: 
          - k3s_cluster
          - "cluster_{{ item.0.name }}"
        ansible_host: "{{ item.0.name }}-node{{ item.1 }}.{{ clusters_data.domainname }}"
        cluster_name: "{{ item.0.name }}"
        domainname: "{{ clusters_data.domainname }}"
        node_index: "{{ item.1 }}"
        is_control_node: "{{ item.1 < item.0.numCnodes }}"
        is_first_control: "{{ item.1 == 0 }}"
        total_nodes: "{{ item.0.numCnodes + item.0.numWnodes }}"
        cluster_total_nodes: "{{ item.0.numCnodes + item.0.numWnodes }}"
        num_control: "{{ item.0.numCnodes }}"          # â† ADD THIS LINE
        num_worker: "{{ item.0.numWnodes }}"
        site: "{{ item.0.site }}"
        owner: "{{ item.0.owner }}"
        appgroups: "{{ item.0.appgroups }}"
        k3s_version: "v1.34.1+k3s1"
        k3s_token: "N2260mN2260m"
      loop: "{{ clusters_data.cluster | product(range(0, 10)) | list }}"
      when: item.1 < (item.0.numCnodes + item.0.numWnodes)

- name: Install k3s on dynamically built inventory
  hosts: k3s_cluster
  become: yes
  gather_facts: yes
  vars:
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
  tasks:
    - name: Validate cluster configuration
      when: is_first_control
      block:
        - name: Validate minimum nodes
          assert:
            that:
              - num_control | int >= 1
            fail_msg: "At least 1 control node is required"
        
        - name: Validate control node count
          assert:
            that:
              - num_control | int == 1 or (num_control | int % 3 == 0)
            fail_msg: "Control nodes must be 1 or multiple of 3 (1, 3, 6, 9...)"
        
        - name: Warn about even control node count
          debug:
            msg: "WARNING: {{ num_control }} control nodes may cause etcd quorum issues. Use odd numbers (1, 3, 5, 7) for proper quorum."
          when: num_control | int > 1 and num_control | int % 2 == 0
        
        - name: Validate worker node count
          assert:
            that:
              - num_worker | int == 0 or num_worker | int == 1 or (num_worker | int % 3 == 0)
            fail_msg: "Worker nodes must be 0, 1, or multiple of 3 (0, 1, 3, 6, 9...)"
        
        - name: Display cluster topology
          debug:
            msg:
              - "Cluster: {{ cluster_name }}"
              - "Control nodes: {{ num_control }}"
              - "Worker nodes: {{ num_worker }}"
              - "Total nodes: {{ cluster_total_nodes }}"
              - "Topology: {{ 'Single node (control+worker)' if cluster_total_nodes | int == 1 else 'HA cluster' }}"

    - name: Install k3s on first control node
      when: is_first_control
      environment:
        K3S_KUBECONFIG_MODE: "644"
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
        INSTALL_K3S_EXEC: "server {{ '--cluster-init' if total_nodes | int > 1 else '' }} --tls-san {{ ansible_host }} --node-name {{ inventory_hostname }} {% for group in appgroups %}{% for key, value in group.items() %}--node-label appgroup/{{ key }}={{ value | lower }} {% endfor %}{% endfor %} --node-label clustername={{ cluster_name }} --node-label domainname={{ domainname }} --node-label node-role=control --disable=traefik"
        K3S_TOKEN: "{{ k3s_token }}"
      shell: |
        curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Install k3s on additional control nodes
      when: is_control_node and not is_first_control
      environment:
        K3S_KUBECONFIG_MODE: "644"
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
        INSTALL_K3S_EXEC: "server --server https://{{ cluster_name }}-node0.{{ domainname }}:6443 --tls-san {{ ansible_host }} --node-name {{ inventory_hostname }} {% for group in appgroups %}{% for key, value in group.items() %}--node-label appgroup/{{ key }}={{ value | lower }} {% endfor %}{% endfor %} --node-label clustername={{ cluster_name }} --node-label domainname={{ domainname }} --node-label node-role=control --disable=traefik"
        K3S_TOKEN: "{{ k3s_token }}"
      shell: |
        curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Install k3s on worker nodes
      when: not is_control_node
      environment:
        K3S_KUBECONFIG_MODE: "644"
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
        INSTALL_K3S_EXEC: "agent --node-name {{ inventory_hostname }} {% for group in appgroups %}{% for key, value in group.items() %}--node-label appgroup/{{ key }}={{ value | lower }} {% endfor %}{% endfor %} --node-label clustername={{ cluster_name }} --node-label domainname={{ domainname }} --node-label node-role=worker"
        K3S_TOKEN: "{{ k3s_token }}"
        K3S_URL: "https://{{ cluster_name }}-node0.{{ domainname }}:6443"
      shell: |
        curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Create /dataz
      when: is_first_control
      file:
        path: /dataz
        state: directory
        
    - name: Install packages
      when: is_first_control
      package:
        name: nfs-common
        state: present
        update_cache: yes
        
    - name: fstab
      when: is_first_control
      lineinfile:
        path: /etc/fstab
        line: "danas.hangar.bpfx.org:/volume1/dataz /dataz nfs defaults 0 0"
        state: present
        
    - name: mount
      when: is_first_control
      shell: |
        mount -a

    - name: Copy and modify kubeconfig to NAS
      when: is_first_control
      block:
        - name: Read k3s kubeconfig
          slurp:
            src: /etc/rancher/k3s/k3s.yaml
          register: kubeconfig_content

        - name: Write modified kubeconfig to NAS
          copy:
            content: "{{ (kubeconfig_content.content | b64decode) | regex_replace('127.0.0.1:6443', cluster_name + '-node0.' + domainname + ':6443') }}"
            dest: /dataz/kube/k3s-{{ cluster_name }}-config.yaml
            mode: '0644'