kube-prometheus-stack:
  crds:
    upgradeJob:
      enabled: true
  alertmanager:
    enabled: true
    ingress:
      enabled: true
      ingressClassName: monitoring-traefik
      annotations:
        kubernetes.io/ingress.class: monitoring-traefik
      hosts:
        - alertmanager.monitoring.abode.tailandtraillabs.org
      tls:
        - secretName: alertmanager-tls
          hosts:
            - alertmanager.monitoring.abode.tailandtraillabs.org
    alertmanagerSpec:
      externalUrl: https://alertmanager.monitoring.abode.tailandtraillabs.org
    config:
      global:
        resolve_timeout: 5m
        smtp_smarthost: 'smtp.gmail.com:587'
        smtp_from: 'bob@bomar.us'
        smtp_auth_username: 'bob@bomar.us'
        smtp_auth_password: '{{ secret "alertmanager-smtp" "password" }}'
        smtp_require_tls: true
      route:
        group_by: ['alertname', 'cluster', 'service']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 12h
        receiver: 'email-bob'
        routes:
          - match:
              severity: critical
            receiver: 'email-bob'
            repeat_interval: 1h
      receivers:
        - name: 'email-bob'
          email_configs:
            - to: 'bob@bomar.us'
              send_resolved: true
              headers:
                Subject: '[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }} - {{ .GroupLabels.cluster }}'
  grafana:
    enabled: true
    ingress:
      enabled: true
      ingressClassName: monitoring-traefik
      annotations:
        kubernetes.io/ingress.class: monitoring-traefik
      hosts:
        - grafana.monitoring.abode.tailandtraillabs.org
      tls:
        - secretName: grafana-tls
          hosts:
            - grafana.monitoring.abode.tailandtraillabs.org
    adminUser: admin
    adminPassword: admin
    # ADDED: Loki datasource
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki-gateway.monitoring.svc.cluster.local:80
        access: proxy
        isDefault: false
  prometheus:
    enabled: true
    ingress:
      enabled: true
      ingressClassName: monitoring-traefik
      annotations:
        kubernetes.io/ingress.class: monitoring-traefik
      hosts:
        - prometheus.monitoring.abode.tailandtraillabs.org
      # ADDED: paths for both UI and remote write
      paths:
        - /
      pathType: Prefix
      tls:
        - secretName: prometheus-tls
          hosts:
            - prometheus.monitoring.abode.tailandtraillabs.org
    # ADDED: prometheusSpec config
    prometheusSpec:
      externalUrl: https://prometheus.monitoring.abode.tailandtraillabs.org
      remoteWrite: []  # Enables remote write endpoint
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi

loki:
  loki:
    # CHANGED: Use filesystem storage instead of S3
    storage:
      type: filesystem
    commonConfig:
      replication_factor: 1
    # CHANGED: Schema config for filesystem
    schemaConfig:
      configs:
        - from: "2024-04-01"
          store: tsdb
          object_store: filesystem  # Changed from s3
          schema: v13
          index: